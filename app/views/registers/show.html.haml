- @page_title = "#{[@register.seo_title, @register.register_name + ' register'].find(&:present?)}"
- @page_description = "#{[@register.meta_description, @register.register_description].find(&:present?)}"
- content_for :body_classes, 'register-show'

%main#content.container{role:'main'}
  - if @register.register_phase != 'Beta'
    .grid-row
      .column-two-thirds
        .panel.panel-border-wide
          %span.phase-banner In progress
          %p This data is in progress and itâ€™s not ready for use.

  .register-meta-data
    .grid-row
      .column-two-thirds
        %h1.heading-large
          #{@register.register_name} register
          %span.heading-secondary= @register.register_description
        - unless @register.is_empty?
          %p.font-xsmall Last updated: #{link_to formatted_date(@register.register_last_updated), register_entries_path(@register.slug)}

      .column-one-third
        - if @register.register_authority.present?
          .related-items
            %p.bold-small Managed by:
            %div{class: "govuk-organisation-logo #{@register.register_authority.data['name'].parameterize}"}
              %div{class: "logo-container #{crest_class_name(@register.register_authority.data['name'].parameterize)}"}
                %span= @register.register_authority.data['name']

  .grid-row
    .column-full
      %div{class: "js-hidden", "data-module" => "accordion-with-descriptions"}
        .subsection-wrapper
          .subsection.js-subsection
            .subsection__header
              %h2.subsection__title Preview the data
            .subsection__content.js-subsection-content#data_section
              - unless @register.is_empty?
                .search-records-wrapper#records_wrapper
                  = form_tag register_path(@register.slug, anchor: 'records_wrapper'), method: :get, id: 'search_records' do
                    .grid-row
                      .column-one-third
                        .records-search
                          = label_tag 'Search', nil, for: 'q', class: 'visually-hidden'
                          = search_field_tag 'q', nil, class: 'search-input', placeholder: 'Search', value: @search_term, autocomplete: 'off'
                          = submit_tag 'Search', name: nil, class: 'search-submit'
                    %details{role: "group", open: (params[:status].present? ? 'open' : nil)}
                      %summary{"aria-controls" => "details-content-0", "aria-expanded" => "#{params[:status].present? ? 'true' : 'false'}", role: "button"}
                        %span.summary Filter
                      %div{id: "details-content-0", "aria-hidden" => "#{params[:status].present? && @records.present? ? 'false' : 'true'}"}

                        .grid-row
                          .column-two-thirds
                            .form-group
                              %fieldset.inline
                                %legend.form-label.form-label-bold Filter data:
                                .multiple-choice
                                  = radio_button_tag 'status', 'current', params[:status] == 'current' || !params[:status].present? ?  'true' : nil
                                  = label_tag 'Current records', nil, for: 'status_current'
                                .multiple-choice
                                  = radio_button_tag 'status', 'archived', params[:status] == 'archived' ?  'true' : nil
                                  = label_tag 'Archived records', nil, for: 'status_archived'
                                .multiple-choice
                                  = radio_button_tag 'status', 'all', params[:status] == 'all' ?  'true' : nil
                                  = label_tag 'Both', nil, for: 'status_all'
                              = submit_tag 'Search', name: nil, class: 'button filter-search-submit'


              - if @records.any?
                .records-count
                  %span#records-count
                    = render partial: 'showing'
                  - if @search_term.present? || params[:status].present?
                    = link_to 'Reset', register_path(@register.slug, anchor: 'records_wrapper'), class: 'reset-link'

              - if @register.is_empty? || @records.any?
                .fullscreen-content{data: {module: 'scrolling-tables'}}
                  %table.table.register-data-table
                    %thead
                      %tr{data: {"click-events" => true, "click-category" => "Register Table", "click-action" => "Sort"}}
                        - @register.register_fields.each do |field|
                          %th{class: "#{field['field']}"}
                            = field['cardinality'] == '1' ? records_table_sort_link(field['field'], request.query_parameters) : field['field'].tr('-', ' ').humanize
                            = link_to register_field_url(@register.slug, field['field']), class: 'info-icon', remote: true do
                              %span.visually-hidden
                                What does #{field['field']} mean
                              ?
                    %tbody#records-tbody
                      - if @register.is_empty?
                        %tr
                          %td{colspan: @register.register_fields.count}
                            .panel.panel-border-wide
                              %p This register currently has no data. The owner of the register will publish the data once it has been gathered.
                      - else
                        = render partial: 'record', collection: @records

              .pager.js-hidden
                .pager-controls
                  = paginate @records, outer_window: 0, window: 3
                .pager-summary
                  = render partial: 'showing'

              - unless @records.last_page?
                %div{data: { "click-events" => true, "click-category" => "Register Table", "click-action" => "Load More" }}
                  = link_to_next_page @records, 'Load more', id: 'load-more-records', class: 'js-load-more', remote: true

              - unless @records.any? || @register.is_empty?
                .no-search-results
                  %p
                    - if @search_term.present?
                      No results found for <strong>"#{@search_term}"</strong>
                    - else
                      No results found.
                    - if @search_term.present? || params[:status].present?
                      = link_to 'Reset', register_path(@register.slug, anchor: 'search_wrapper'), class: 'reset-link'
          - if @records.any?
            .subsection--not-active
              .subsection__header--not-active
                %h2.subsection__title--not-active Access the data
          .subsection.js-subsection
            .subsection__header
              %h2.subsection__title Give feedback
            .subsection__content.js-subsection-content#feedback_section
              = render partial: 'feedback/form'

%dialog#modal_dialog.modal-dialog.dialog{role: "dialog", "aria-hidden" => "true", "aria-labelledby" => "dialog-title"}
  %button{type: 'button', class: 'modal-dialog__close', "aria-label" => "Close dialog"} Close
  .modal-dialog__inner

= content_for :javascript do
  :javascript
    $("input[name='status']").change(function () {
      $('#search_records').submit();
    });

= content_for :head do
  = render partial: 'registers/structured_data', locals: { register: @register }
