- @page_title = "#{[@register.seo_title, @register.register_name + ' register'].find(&:present?)}"
- @page_description = "#{[@register.meta_description, @register.register_description].find(&:present?)}"
- content_for :body_classes, 'register-show'

.govuk-width-container
  %main#content.govuk-main-wrapper{role:'main'}
    .govuk-grid-row
      .govuk-grid-column-two-thirds
        - if @register.register_phase != 'Beta'
          .govuk-inset-text
            %strong.govuk-tag In progress
            %p This data is in progress and itâ€™s not ready for use.
        %h1{class: "govuk-heading-l govuk-!-margin-top-7 govuk-!-margin-bottom-1"}
          #{@register.register_name} register
        %p.govuk-body-l= @register.register_description
        %dl.govuk-metadata
          - if @register.authority.present?
            %dt.register-metadata__term Organisation:
            %dd.register-metadata__definition= @register&.authority&.name
          - if @register&.category_id&.present? or @register.register_phase != 'Beta'
            %dt.register-metadata__term Category:
            %dd.register-metadata__definition= link_to @register_category.name, category_path(@register_category.slug)
          - unless @register.is_empty?
            %dt.register-metadata__term Last updated:
            %dd.register-metadata__definition= link_to formatted_date(@register.register_last_updated), register_entries_path(@register.slug)
        %p= link_to 'Access the data', register_choose_access_path(@register.slug), { class: 'registers__button--access govuk-!-margin-top-5'}
    .govuk-grid-row#records_wrapper
      .govuk-grid-column-two-thirds
        %h2{class: "govuk-heading-m"}
          About the data
        %p This register has #{number_with_delimiter(@records.total_count)} records and #{@register.register_fields.count} fields.
      .govuk-grid-column-one-third
        = form_tag register_path(@register.slug, anchor: 'records_wrapper'), method: :get, id: 'search_records' do
          = label_tag 'Search', nil, for: 'q', class: 'visually-hidden'
          = search_field_tag 'q', nil, class: 'search-input', placeholder: 'Search', value: @search_term, autocomplete: 'off'
          = submit_tag 'Search', name: nil, class: 'search-submit'
      .govuk-grid-column-full
        %p{class: 'govuk-!-margin-bottom-2'}
          - unless @search_term.present? || params[:status].present?
            Showing
            %strong 1 &ndash; #{@records.count + @records.offset_value}
            of
            %strong= @records.total_count
            records.
          - if @search_term.present? || params[:status].present?
            Showing #{@records.count} records for <strong>&ldquo;#{@search_term}&rdquo;</strong>.
            = link_to 'Reset', register_path(@register.slug, anchor: 'records_wrapper'), class: 'reset-link'
        - if @register.is_empty? || @records.any?
          .fullscreen-content{data: {module: 'scrolling-tables'}}
            %table.table.register-data-table
              %thead
                %tr
                  - @register.register_fields.each do |field|
                    %th{class: "#{field['field']}"}
                      = field['cardinality'] == '1' ? records_table_sort_link(field['field'], request.query_parameters) : field['field'].tr('-', ' ').humanize
                      = link_to register_field_url(@register.slug, field['field']), class: 'info-icon', remote: true, data: {"click-events" => true, "click-category" => "Register Table", "click-action" => "Help"} do
                        %span.visually-hidden
                          What does #{field['field']} mean
                        ?
              %tbody#records-tbody
                - if @register.is_empty?
                  %tr
                    %td{colspan: @register.register_fields.count}
                      .panel.panel-border-wide
                        %p This register currently has no data. The owner of the register will publish the data once it has been gathered.
                - else
                  = render partial: 'record', collection: @records
        - unless @records.any? || @register.is_empty?
          .no-search-results
            %p
              - if @search_term.present?
                No results found for <strong>"#{@search_term}"</strong>
                %script
                  var searchFilter = document.getElementById('search_records').querySelector('input[type="radio"]:checked').parentElement.querySelector('label').innerText.toLowerCase();
                  ga('send', 'event', 'Search', 'No results filtered by: ' + searchFilter, '#{@search_term}', {nonInteraction: true});
              - else
                No results found.
                %script
                  ga('send', 'event', 'Search', 'No results', 'Search term not present');
              - if @search_term.present? || params[:status].present?
                = link_to 'Reset', register_path(@register.slug, anchor: 'search_wrapper'), class: 'reset-link'
    #section{class: 'govuk-!-margin-top-4 govuk-grid-row'}
      .govuk-grid-column-full
        %h2{class: "govuk-heading-m"}
          Feedback
        = render partial: 'feedback/form'

%dialog#modal_dialog.modal-dialog.dialog{role: "dialog", "aria-hidden" => "true", "aria-labelledby" => "dialog-title"}
  %button{type: 'button', class: 'modal-dialog__close', "aria-label" => "Close dialog"} Close
  .modal-dialog__inner

= content_for :javascript do
  :javascript
    $("input[name='status']").change(function () {
      $('#search_records').submit();
    });

= content_for :head do
  = render partial: 'registers/structured_data', locals: { register: @register }
